rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }

    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function role() {
      return signedIn() && userDoc().data.role != null ? userDoc().data.role : "employee";
    }

    // Users: each user can read/write their own profile
    match /users/{uid} {
      allow read: if signedIn() && request.auth.uid == uid;
      // Allow create by the user at signup
      allow create: if signedIn() && request.auth.uid == uid;
      // Only managers can change roles (you as admin should do this in console; this keeps it safe-ish)
      allow update: if signedIn() && (request.auth.uid == uid) && !( "role" in request.resource.data.diff(resource.data).changedKeys() )
                   || (signedIn() && role() == "manager"); // manager can edit (optional)
      allow delete: if false;
    }

    // Time logs (one per user per date, id: uid_YYYY-MM-DD)
    match /timeLogs/{logId} {
      // Employees can read their own logs
      allow read: if signedIn() && (
        resource.data.uid == request.auth.uid
        || role() == "manager"
      );

      // Employees can write only their own logs; managers can write (optional)
      allow create, update: if signedIn() && (
        request.resource.data.uid == request.auth.uid
        || role() == "manager"
      );

      allow delete: if false;
    }
  }
}
